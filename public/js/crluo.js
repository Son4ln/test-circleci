(function($){"use strict";$.ajaxSetup({headers:{'X-CSRF-TOKEN':$('meta[name="csrf-token"]').attr('content')}});var Crluo=function(){this.ctor.apply(this)};Crluo.prototype={ctor:function(){var self=this,_timerobj,_messageobj},messageReaded:function($button){$.get('/ajax/readed/'+$button.attr('data-messageid'),function(data){if(data>0){$button.removeClass('glyphicon-eye-open').addClass('glyphicon-ok').attr("disabled",!0).prop('type','none');self._message_load(self)}else{alert("更新失敗")}})},messageReaded2:function($button){var self=this;$.get('/ajax/readed/'+$button.attr('data-messageid'),function(data)
{if(data>0){$button.parent().parent().parent().removeClass('panel-default');$button.click('')}else{}})},messageLoad:function(obj){if(!obj){return}
var self=this;self._messageobj=obj;self._message_load(self);self._timerobj=setInterval(function(){self._message_load(self)},60000);$(obj).on('show.bs.popover',function(){clearInterval(self._timerobj)});$(obj).on('hidden.bs.popover',function(){self._timerobj=setInterval(function(){self._message_load(self)},60000)})},_message_load:function(obj){var self=obj;$.ajaxSetup({async:!1});self._messageobj.each(function(){obj=$(this);var kind=obj.data('messagekind');$.get('/ajax/unseencount/'+kind,function(responce){if(responce>0){if(kind==1){$('span',obj).addClass('btn-info').html(responce)}else{$('span',obj).addClass('btn-warning').html(responce)}}else{if(kind==1){$('span',obj).removeClass('btn-info').html('')}else{$('span',obj).removeClass('btn-warning').html('')}}});$.get('/ajax/message/'+kind,function(responce){obj.next().html(responce)}).fail(function(){$(location).attr("href","/")})});$.ajaxSetup({async:!0})},ajax_sync_form:function(urlstr,param){$('.preloader').show()
var ret;var promise=new Promise(function(resolve,reject){$.ajax({url:urlstr,data:param,type:"post",timeout:1500000,processData:!1,contentType:!1,dataType:"html",success:function(data){resolve(data);$('textarea[name=message]','#sendmesform').val('')},error:function(xhr,status){reject(xhr.status)},complete:function(xhr,status){$('.preloader').fadeOut()}})});return promise},ajax_async_form:function(urlstr,param,progress,success){var div=$('.preloader').fadeIn();var p;if(!success){success=function(data){}}
if(progress){p=$(progress);$(p).parent('.progress').show();$(p).attr('aria-valuenow',0);p.text(0);p.css('width','0'+'%')}
var ret;$.ajax({async:!0,url:urlstr,data:param,type:"post",processData:!1,contentType:!1,dataType:"html",xhr:function(){var xhr=new window.XMLHttpRequest();xhr.upload.addEventListener("progress",function(evt){if(evt.lengthComputable&&p){var percentComplete=Math.round(evt.loaded/evt.total*100);p.attr('aria-valuenow',percentComplete);p.text(percentComplete+"%");p.css('width',percentComplete+"%")}},!0);return xhr},success:function(data){success(data)},error:function(xhr,status){ret={ret:xhr.status,data:xhr.responseText}},complete:function(xhr,status){if(p){$(p).attr('aria-valuenow',0);p.text(0);p.css('width','0'+'%');$(p).parent('.progress').hide();div.fadeOut()}}});return ret},ajax_sync:function(urlstr,param){var div=$('.preloader').fadeIn();var ret;var method='post';if(urlstr.indexOf("?")>0){console.log('get '+urlstr)
method='get'}
$.ajax({async:!1,url:urlstr,data:param,type:method,dataType:"html",success:function(data){ret={ret:0,data:data}},error:function(xhr,status){ret={ret:xhr.status,data:xhr.responseText}},complete:function(xhr,status){div.fadeOut()}});return ret}};$.crluo=new Crluo();$.fn.crluoFormInputSearch=function(options){var settings=$.extend({},{url:'',dest:''},{url:$(this).attr('action')},options);var self=this;$(this).submit(function(){return!1});return $('input, select',self).each(function(){var obj=$(this).change(function(e){if(typeof options.callback=='function'){options.callback.call(this)}
e.preventDefault();var data=new FormData($(self).get()[0]);$.crluo.ajax_sync_form(settings.url,data).then(function(response){$(settings.dest).html(response)});return!1})})}
$.fn.crluoFormSubmit=function(options){var settings=$.extend({},{url:'',dest:'',before:null},{url:$(this).attr('action')},options);var self=this;$(this).submit(function(){return!1});return $('.ui-submit',self).each(function(){var obj=$(this).click(function(e){e.preventDefault();if(settings.before){if(settings.before()){return!1}}
var data=new FormData($(self).get()[0]);$.crluo.ajax_sync_form(settings.url,data).then(function(response){if(settings.dest!=''){$(settings.dest).html(response)}});$('textarea[name=message]','#sendinfoform').val('')
return!1})})}
$.fn.crluoModalFormSubmit=function(options){var settings=$.extend({},{url:'',dest:'',after:''},{url:$(this).attr('action')},options);var self=this;$(this).submit(function(){return!1});return $('.ui-submit',self).each(function(){var obj=$(this).click(function(e){e.preventDefault();var data=new FormData($(self).get()[0]);$.crluo.ajax_sync_form(settings.url,data).then(function(response){if(settings.dest!=''&&response.data!=''){$(settings.dest).html(response)}else{$('#modalWindow').modal('hide');if(settings.after){settings.after()}}});return!1})})}
$.fn.crluoDelete=function(options){var settings=$.extend({},{url:'',dest:''},options);var self=this;return $(self).each(function(){var obj=$(this).click(function(e){var $parent=$(this).parents('.ui-del-parent');e.preventDefault();var data={'id':$(this).attr('data-id')}
var ret=$.crluo.ajax_sync(settings.url,data);if(settings.dest!=''){$(settings.dest).html(ret.data)}else{if(ret.ret==0){$parent.remove()}}
return!1})})}
$.fn.crluoPagenation=function(options){var settings=$.extend({},{url:'',dest:''},options);var self=this;return $('.pagination',settings.dest).find('a').each(function(){var obj=$(this).click(function(e){e.preventDefault();var data=new FormData($(self).get()[0]);var url=$(this).attr('href').split('?');var param=url[1].split('&');for(var i=0;i<param.length;i++){var item=param[i].split('=');data.append(item[0],item[1])}
$.crluo.ajax_sync_form(url[0].replace(/\/$/g,''),data).then(function(response){$(settings.dest).html(response)});return!1})})}
$.fn.crluoPagenationNonForm=function(options){console.log(options);var settings=$.extend({},{url:'',dest:''},options);var self=this;var bv=$('.pagination',self).find('a');console.log(bv);return $('.pagination',self).find('a').each(function(){var obj=$(this).click(function(e){console.log(obj);e.preventDefault();var data=settings;var ret=$.crluo.ajax_sync($(this).attr('href'),data);$(settings.dest).html(ret.data);return!1})})}
$.fn.crluoPagenationNonFormUpdate=function(options){var settings=$.extend({},{url:'',dest:''},options);var self=this;var bv=$('.pagination').find('a');console.log(bv.length);$('ul.pagination').find('a').each(function(){var obj=$(this).click(function(e){console.log(obj);e.preventDefault();var data=settings;var ret=$.crluo.ajax_sync($(this).attr('href'),data);$(settings.dest).html(ret.data);return!1})});return!1}
$.fn.crluoDispChat=function(options){var settings=$.extend({},{dest:''},options);var self=this;return $('button',self).each(function(){var obj=$(this).click(function(e){e.preventDefault();$(this).children().remove('span');var data={'user_id':$(this).attr('data-id')};window.history.pushState("","","?user="+$(this).attr('data-id'));var ret=$.crluo.ajax_sync('/messages/box',data);$(settings.dest).html(ret.data);return!1})})}
$.fn.crluoPortfolioDelete=function(options){var settings=$.extend({},{dest:''},options);var self=this;return $(self).each(function(){var obj=$(this).click(function(e){var $parent=$(this).parent();var $id=$(this).attr('data-procname');e.preventDefault();var data={'id':$id}
var ret=$.crluo.ajax_sync('/ajax/portfolio/delete',data);if(ret.ret==0){$parent.parent().remove()}
return!1})})}
$.fn.crluoFileDrop=function(options){var settings=$.extend({},{url:'',dest:'',progress:null,msgarea:null},options);var self=this;return $(self).each(function(){$(this).bind("drop",function(event){event.preventDefault();event.stopPropagation();var file=event.originalEvent.dataTransfer.files[0];if(!settings.msgarea){settings.msgarea=this}
$(settings.msgarea).text("["+file.name+"]");var fd=new FormData();$.each(settings,function(key,item){if(['url','dest','before','after','progress','msgarea'].indexOf(key)!=-1){return}
fd.append(key,item)});fd.append("file",file);var ret=$.crluo.ajax_async_form(settings.url,fd,settings.progress,function(data){if(settings.dest!=''&&data!=''){$(settings.dest).html(data)}});return!1}).bind('dragenter',function(event){event.preventDefault();event.stopPropagation();return!1}).bind('dragover',function(event){$(this).css('backgroundColor','#EFF2AA');event.preventDefault();event.stopPropagation();return!1}).bind('dragleave',function(event){$(this).css('backgroundColor','transparent');event.preventDefault();event.stopPropagation();return!1})})}
$.fn.crluoVideoList=function(options){return $(this).each(function(){var $list=$(this);var url=$(this).attr('data-remote');var settings=$.extend({},{url:url,progress:null,msgarea:null},options)})};$.fn.crluoDraggableVideo=function(options){var settings=$.extend({},{id:'dragvideo',src:{},title:'ドラッグで拡大縮小・移動できます'},options);var width=($(window).width()/4)*3;var div=$('<div id="'+settings.id+'" class="panel panel-default" style="position:fixed;z-index:99999998;width:'+width+'px;border: 4px solid black;" draggable="true">');var video=$('<video controls width=100% height=100%>')
$.each(settings.src,function(){$(video).append("<source src='"+this+"'>")});$(div).append(video);$(div).append("<span class='btn btn-large glyphicon glyphicon-remove ui-pallet-del' style='color: white;position:absolute;top:0;right:0;background: rgba(122, 130, 136, 0.2)!important;'></span>");$(div).hide();$(this).eq(0).after(div);var id='#'+settings.id;$(id).draggable().resizable({aspectRatio:!0,ghost:!0,handles:"n, e, s, w",resize:function(event,ui){$(id).css('left',ui.originalPosition.left);$(id).css('top',ui.originalPosition.top);$(id).css('position','fixed')}});$('video',id).resize(function(){$(id).css('height',$('video',id).height+8)});$('.ui-pallet-del',id).click(function(){$('video',id).get(0).currentTime=0;$('video',id).get(0).pause();$(id).hide()});$(this).click(function(){$('video',id).get(0).play();$(id).show()});return $(this)}
$.fn.crluoDeleteRest=function(options){var settings=$.extend({},{url:'',dest:''},options);var self=this;return $(self).each(function(){var obj=$(this).click(function(e){var $parent=$(this).parents('.ui-del-parent');e.preventDefault();var data={'_method':'DELETE'}
var ret;$.ajax({async:!1,url:settings.url+'/'+$(this).attr('data-id'),data:data,type:'post',dataType:"html",success:function(data){ret={ret:0,data:data}},error:function(xhr,status){ret={ret:xhr.status,data:xhr.responseText}},complete:function(xhr,status){}});if(settings.dest!=''){$(settings.dest).html(ret.data)}else{if(ret.ret==0){$parent.remove()}}
return!1})})}}(jQuery))